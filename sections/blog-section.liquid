{%- assign blog_obj = nil -%}
{%- if blog -%}
  {%- assign blog_obj = blog -%}
{%- elsif section.settings.blog_source != blank -%}
  {%- assign blog_obj = section.settings.blog_source -%}
{%- endif -%}
{%- assign per_page = section.settings.per_page | default: 4 -%}
{%- assign active_tag = current_tags | first -%}

{% style %}
.section-{{ section.id }}-padding {
  padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
  padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
}
@media screen and (min-width: 750px) {
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
  }
}
.blog-title--center {
  text-align: center;
  font-size: 32px;
  line-height: 1.2;
  font-weight: 700;
  color: var(--color-main-text);
  font-family: var(--font-heading-main);
  margin: 0 0 28px 0;
}
.blog-wrap {
  max-width: 1160px;
  margin: 0 auto;
  display: flex;
  gap: 40px;
  justify-content: space-between;
}
.blog-nav {
  position: sticky;
  top: 60px;
  align-self: flex-start;
}
.blog-nav__title {
  font-size: 24px;
  line-height: 1.2;
  font-weight: 700;
  color: var(--color-main-text);
  font-family: var(--font-heading-main);
  margin: 0 0 16px 0;
}
.blog-nav__list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}
.blog-nav__item {
  min-width: 300px;
  padding: 16px 0;
  border-bottom: 1px solid #D7D7D7;
}
.blog-nav__item:first-child {
  border-top: 1px solid #D7D7D7;
}
.blog-nav__link {
  text-decoration: none;
  background: none;
  border: 0;
  color: #87878D;
  font-size: 16px;
  line-height: 16px;
  font-family: var(--font-heading-main);
  transition: color 0.2s ease, font-weight 0.2s ease;
}
.blog-nav__link:hover,
.blog-nav__link.is-active {
  color: var(--color-main-text);
  font-weight: 600;
}
.is-desktop { display: block; }
.is-mobile  { display: none; }
.blog-select-wrap {
  position: relative;
  width: 100%;
}
.blog-select {
  width: 100%;
  padding: 12px 40px 12px 12px;
  font-size: 14px;
  line-height: 16px;
  font-family: var(--font-heading-main);
  border: 1px solid #D7D7D7;
  border-radius: 16px;
  background: #fff;
  color: #87878D;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}
.blog-select__icon {
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  display: inline-flex;
  align-items: center;
}
.blog-content {
  max-width: 736px;
  width: 100%;
}
.blog-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 28px;
}
.blog-card {
  display: grid;
  grid-template-columns: 1fr;
  gap: 14px;
  text-decoration: none;
  background: #fff;
  border: 1px solid #EDEDED;
  border-radius: 16px;
  padding: 14px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.blog-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
}
.blog-card__media {
  width: 100%;
  overflow: hidden;
  border-radius: 12px;
}
.blog-card__media img {
  display: block;
  width: 100%;
  height: auto;
  border-radius: 12px;
}
.blog-card__meta {
  font-size: 12px;
  line-height: 1.4;
  color: var(--color-main-text);
  opacity: 0.7;
  margin: 0 0 6px 0;
}
.blog-card__title {
  font-size: 18px;
  line-height: 1.3;
  font-weight: 700;
  color: var(--color-main-text);
  margin: 2px 0 6px 0;
}
.blog-card__text {
  font-size: 14px;
  line-height: 20px;
  color: var(--color-main-text);
  opacity: 0.85;
  margin: 0;
}
.pagination {
  display: flex;
  align-items: center;
  gap: 6px;
  justify-content: center;
  margin-top: 16px;
}
.pagination a,
.pagination span {
  min-width: 34px;
  height: 34px;
  padding: 0 10px;
  border-radius: 10px;
  border: 1px solid #D7D7D7;
  background: #fff;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  line-height: 32px;
  text-decoration: none;
  color: inherit;
}
.pagination .current {
  background: #111;
  color: #fff;
  border-color: #111;
}
@media screen and (max-width: 749px) {
  .blog-wrap {
    padding: 0 10px;
    flex-direction: column;
  }
  .blog-nav {
    position: static;
    top: auto;
  }
  .is-desktop { display: none; }
  .is-mobile  { display: block; margin-bottom: 24px; }
  .blog-title--center {
    font-size: 24px;
  }
}
{% endstyle %}

<div class="section-{{ section.id }}-padding">
  {% if blog_obj == blank %}
    <div class="page-width">
      <h1 class="blog-title--center">{{ blog.title | escape }}</h1>
      <p style="opacity:.7; text-align:center;">No blog found. If this section is placed on a non-blog page, please select a <strong>Blog Source</strong> in the section settings.</p>
    </div>
  {% else %}
    <div class="page-width">
      <h1 class="blog-title--center">{{ blog_obj.title | escape }}</h1>
    </div>

    <div class="blog-wrap page-width">
      <aside class="blog-nav" aria-label="Blog categories">
        <h2 class="blog-nav__title">{{ section.settings.sidebar_title | default: 'Category' }}</h2>

        {% assign sidebar_active_tag = active_tag %}

        <ul class="blog-nav__list is-desktop">
          {% for tag in blog_obj.all_tags %}
            {% assign is_active = false %}
            {% if sidebar_active_tag == tag %}
              {% assign is_active = true %}
            {% elsif sidebar_active_tag == blank and forloop.first %}
              {% assign is_active = true %}
            {% endif %}
            <li class="blog-nav__item">
              <a
                class="blog-nav__link {% if is_active %}is-active{% endif %}"
                href="{{ blog_obj.url }}/tagged/{{ tag | handle }}"
                {% if is_active %}aria-current="true"{% endif %}
              >
                {{ tag }}
              </a>
            </li>
          {% endfor %}
        </ul>

        <div class="blog-select-wrap is-mobile">
          <select
            class="blog-select"
            onchange="if(this.value) window.location.href=this.value"
            aria-label="Select blog category"
          >
            {% for tag in blog_obj.all_tags %}
              {% assign is_selected = false %}
              {% if sidebar_active_tag == tag %}
                {% assign is_selected = true %}
              {% elsif sidebar_active_tag == blank and forloop.first %}
                {% assign is_selected = true %}
              {% endif %}
              <option
                value="{{ blog_obj.url }}/tagged/{{ tag | handle }}"
                {% if is_selected %}selected{% endif %}
              >
                {{ tag }}
              </option>
            {% endfor %}
          </select>

          <span class="blog-select__icon" aria-hidden="true">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" role="img" focusable="false">
              <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
        </div>
      </aside>

      <main class="blog-content" role="main">
        {% paginate blog_obj.articles by per_page %}
          <div class="blog-grid">
            {% for article in blog_obj.articles %}
              <a class="blog-card" href="{{ article.url }}" aria-label="{{ article.title | escape }}">
                {% if section.settings.show_image and article.image %}
                  <div class="blog-card__media">
                    <img
                      src="{{ article.image | img_url: '800x' }}"
                      alt="{{ article.image.alt | default: article.title | escape }}"
                      loading="lazy"
                    >
                  </div>
                {% endif %}

                {% if section.settings.show_date or section.settings.show_author %}
                  <p class="blog-card__meta">
                    {% if section.settings.show_date %}
                      {{ article.published_at | date: format: 'abbreviated_date' }}
                    {% endif %}
                    {% if section.settings.show_author and article.author != blank %}
                      {% if section.settings.show_date %} • {% endif %}
                      {{ article.author }}
                    {% endif %}
                  </p>
                {% endif %}

                <h3 class="blog-card__title">{{ article.title }}</h3>

                {% if section.settings.show_excerpt %}
                  <p class="blog-card__text">
                    {{ article.excerpt_or_content | strip_html | truncate: 140 }}
                  </p>
                {% endif %}
              </a>
            {% endfor %}
          </div>

          {% if paginate.items > 4 and paginate.pages > 1 %}
            <nav class="pagination" role="navigation" aria-label="Pagination">
              {% if paginate.previous %}
                <a href="{{ paginate.previous.url }}" aria-label="Previous page">‹</a>
              {% endif %}

              {% for part in paginate.parts %}
                {% if part.is_link %}
                  <a href="{{ part.url }}">{{ part.title }}</a>
                {% else %}
                  <span class="{% if part.title == paginate.current_page %}current{% endif %}">{{ part.title }}</span>
                {% endif %}
              {% endfor %}

              {% if paginate.next %}
                <a href="{{ paginate.next.url }}" aria-label="Next page">›</a>
              {% endif %}
            </nav>
          {% endif %}
        {% endpaginate %}
      </main>
    </div>
  {% endif %}
</div>

{% schema %}
{
  "name": "Blog cards with sidebar",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "blog",
      "id": "blog_source",
      "label": "Blog Source (used if not on a blog template)",
      "info": "Select a blog when using this section on non-blog pages"
    },
    {
      "type": "text",
      "id": "sidebar_title",
      "label": "Sidebar title",
      "default": "Category"
    },
    {
      "type": "range",
      "id": "per_page",
      "label": "Posts per page",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 4
    },
    {
      "type": "checkbox",
      "id": "show_image",
      "label": "Show featured image",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_excerpt",
      "label": "Show excerpt",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_date",
      "label": "Show publish date",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_author",
      "label": "Show author",
      "default": false
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 36
    }
  ],
  "presets": [
    { "name": "Blog cards with sidebar" }
  ]
}
{% endschema %}