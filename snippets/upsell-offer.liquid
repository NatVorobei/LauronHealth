{% comment %} <script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script> {% endcomment %}
{{ 'component-rating.css' | asset_url | stylesheet_tag }}

{% assign cart_product_handles = cart.items | map: 'product' | map: 'handle' %}
{% assign product_handle_a = settings.product_handle_a %}
{% assign product_handle_b = settings.product_handle_b %}

{% if cart_product_handles contains product_handle_a %}
  {% assign upsell_handle = product_handle_b %}
{% elsif cart_product_handles contains product_handle_b %}
  {% assign upsell_handle = product_handle_a %}
{% else %}
  {% assign upsell_handle = null %}
{% endif %}

{% assign upsell_product = all_products[upsell_handle] %}

{% if settings.show_upsell_offer and upsell_product %}
  {% assign cart_contains_upsell = false %}
  {% for item in cart.items %}
    {% if item.product.handle == upsell_product.handle %}
      {% assign cart_contains_upsell = true %}
    {% endif %}
  {% endfor %}

  {% unless cart_contains_upsell %}
    <div class="drawer__upsell">
      <h3 class="drawer__upsell-heading">{{ settings.upsell_title }}</h3>

      <div class="drawer__upsell-card">
        <div class="drawer__upsell-image">
          <img
            src="{{ upsell_product.featured_image | image_url: width: 200 }}"
            alt="{{ upsell_product.title }}"
            loading="lazy"
          >
        </div>
        <div class="drawer__upsell-content">
          {%- if upsell_product.metafields.reviews.rating.value != blank -%}
            {% liquid
              assign rating_val = upsell_product.metafields.reviews.rating.value
              assign rating_decimal = 0
              assign decimal = rating_val.rating | modulo: 1
              if decimal >= 0.3 and decimal <= 0.7
                assign rating_decimal = 0.5
              elsif decimal > 0.7
                assign rating_decimal = 1
              endif
            %}
            <div class="drawer__upsell-rating rating-wrapper">
              <div
                class="rating"
                role="img"
                aria-label="{{ 'accessibility.star_reviews_info' | t: rating_value: rating_val, rating_max: rating_val.scale_max }}"
              >
                <span
                  aria-hidden="true"
                  class="rating-star"
                  style="--rating: {{ rating_val.rating | floor }}; --rating-max: {{ rating_val.scale_max }}; --rating-decimal: {{ rating_decimal }};"
                ></span>
              </div>
              <p class="rating-count caption">
                <span aria-hidden="true">{{ upsell_product.metafields.reviews.rating_count }} reviews</span>
                <span class="visually-hidden">
                  {{ upsell_product.metafields.reviews.rating_count }}
                  {{ 'accessibility.total_reviews' | t }}
                </span>
              </p>
            </div>
          {%- endif -%}

          <div class="drawer__upsell-title">{{ upsell_product.title }}</div>
          {% if upsell_product.metafields.custom.cart_drawer_description.value != blank %}
            <div class="drawer__upsell-subtitle">
              {{ upsell_product.metafields.custom.cart_drawer_description.value }}
            </div>
          {% endif %}
          <div class="drawer__upsell-bottom">
            <div class="darwer__upsell-info">
              <div class="drawer__upsell-prices">
                {% assign variant = upsell_product.variants.first %}
                {% if variant.compare_at_price > variant.price %}
                  <span class="price--compare">{{ variant.compare_at_price | money }}</span>
                {% endif %}
                <span class="price--main">{{ variant.price | money }}</span>
              </div>
              <p class="drawer__upsell-variantDesr">{{ variant.metafields.custom.variant_description.value }}</p>
            </div>

            {% comment %} <product-form data-section-id="upsell-form" class="custom-product-form" data-appstle-ignore="true">
              {% form 'product',
                upsell_product,
                class: 'drawer-product-form appstle-ignore-in-drawer',
                data-type: 'upsell-form'
              %}
                <div data-appstle-ignore="true">
                  <input
                    type="hidden"
                    name="id"
                    value="{{ variant.id }}"
                    class="product-variant-id"
                    {% unless variant.available %}
                      disabled
                    {% endunless %}
                  >

                  <button
                    type="submit"
                    name="add"
                    class="drawer__upsell-button"
                    aria-live="polite"
                    {% unless variant.available %}
                      disabled
                    {% endunless %}
                  >
                    <span>
                      {% if variant.available %}
                        {{ settings.upsell_buy_button }}
                      {% else %}
                        {{ 'products.product.sold_out' | t }}
                      {% endif %}
                    </span>
                    <span class="sold-out-message hidden">
                      {{ 'products.product.sold_out' | t }}
                    </span>
                    {% render 'loading-spinner' %}
                  </button>
                </div>
              {% endform %}
            </product-form> {% endcomment %}

            <div class="drawer__upsell-actions">
  <form class="upsell-add-form" novalidate>
    <input type="hidden" name="id" value="{{ variant.id }}">
    <input type="hidden" name="quantity" value="1">
    <button type="submit" class="drawer__upsell-button js-upsell-submit" {% unless variant.available %}disabled{% endunless %}>
      <span>{{ settings.upsell_buy_button }}</span>
      <span class="loading__spinner hidden">{% render 'loading-spinner' %}</span>
    </button>
  </form>
</div>



          </div>
        </div>
      </div>
    </div>
  {% endunless %}
{% endif %}

<script>
(function () {
  // Не підключати двічі
  if (window.__upsellBind) return; 
  window.__upsellBind = true;

  // Які секції підтягувати з сервера (Dawn)
  const SECTIONS = ['cart-drawer', 'cart-icon-bubble'];

  async function fetchSections(sections) {
    const url = `/?sections=${encodeURIComponent(sections.join(','))}`;
    const res = await fetch(url, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error('Sections fetch failed');
    return res.json();
  }

  function replaceCartDrawer(htmlMap) {
    const html = htmlMap['cart-drawer'];
    if (!html) return false;

    const temp = document.createElement('div');
    temp.innerHTML = html;

    const newDrawer = temp.querySelector('#CartDrawer');
    const curDrawer = document.querySelector('#CartDrawer');

    if (newDrawer && curDrawer) {
      curDrawer.replaceWith(newDrawer);
      // відкрити дравер
      const drawerEl = document.querySelector('cart-drawer');
      if (drawerEl && typeof drawerEl.open === 'function') drawerEl.open();
      document.documentElement.classList.add('cart-open');
      const overlay = document.getElementById('CartDrawer-Overlay') || document.querySelector('.cart-drawer__overlay');
      if (overlay) overlay.classList.add('is-visible');
      return true;
    }
    return false;
  }

  function replaceBubble(htmlMap) {
    const html = htmlMap['cart-icon-bubble'];
    if (!html) return;
    const temp = document.createElement('div');
    temp.innerHTML = html;
    const newBubble = temp.querySelector('#cart-icon-bubble');
    const curBubble = document.getElementById('cart-icon-bubble');
    if (newBubble && curBubble) curBubble.replaceWith(newBubble);
  }

  document.addEventListener('submit', async (e) => {
    const form = e.target.closest('.upsell-add-form');
    if (!form) return;

    e.preventDefault();

    const btn = form.querySelector('.js-upsell-submit') || form.querySelector('[type="submit"]');
    const spinner = form.querySelector('.loading__spinner');

    // disable UI
    if (btn) { btn.setAttribute('aria-disabled', 'true'); btn.classList.add('loading'); }
    if (spinner) spinner.classList.remove('hidden');

    try {
      // 1) add to cart (як Dawn)
      const fd = new FormData(form);
      // Додаємо sections_url, щоб сервер знав контекст
      fd.append('sections_url', window.location.pathname);

      const addRes = await fetch('/cart/add.js', {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Accept': 'application/json' },
        body: fd
      });
      const addJson = await addRes.json();
      if (!addRes.ok || (addJson && addJson.status)) {
        console.warn('[Upsell] Add error:', addJson);
        return; // можна показати toast помилки
      }

      // 2) підтягнути свіжі секції і замінити
      const sectionsJson = await fetchSections(SECTIONS);
      const drawerReplaced = replaceCartDrawer(sectionsJson);
      replaceBubble(sectionsJson);

      // якщо з якоїсь причини drawer не замінився — спробуємо хоча б відкрити існуючий
      if (!drawerReplaced) {
        const drawerEl = document.querySelector('cart-drawer');
        if (drawerEl && typeof drawerEl.open === 'function') drawerEl.open();
        document.documentElement.classList.add('cart-open');
      }
    } catch (err) {
      console.error('[Upsell] Failure:', err);
      // НІЯКОГО reload — просто не закриваємо дравер
    } finally {
      if (btn) { btn.classList.remove('loading'); btn.removeAttribute('aria-disabled'); }
      if (spinner) spinner.classList.add('hidden');
    }
  });
})();
</script>


<style>
  .drawer__upsell .appstle_subscription_widget,
  .drawer__upsell [id^="appstle_widget_"],
  .drawer__upsell .appstle-inline-widget,
  .drawer__upsell .appstle_block {
    display: none !important;
  }
  .drawer__upsell {
      flex: 1;
      margin-bottom: 20px;
    }

  .drawer__upsell-heading {
    font-weight: 700;
    font-family: var(--font-heading-main);
    font-size: 10px;
    line-height: 10px;
    color: #000;
    margin-bottom: 16px;
  }

  .drawer__upsell-card {
    display: flex;
    gap: 16px;
    align-items: flex-start;
    border: 1px solid #D7D7D7;
    border-radius: 14px;
    padding: 14px;
  }

  .drawer__upsell-image img {
    width: 80px;
    height: auto;
    border-radius: 6px;
  }

  .drawer__upsell-content {
    flex: 1;
  }

  .drawer__upsell-rating {
    font-size: 12px;
    color: #555;
  }

  .drawer__upsell-title {
    font-weight: 700;
    font-family: var(--font-heading-main);
    font-size: 12px;
    line-height: 8px;
    color: var(--color-main-text);
    margin-bottom: 6px;
  }

  .drawer__upsell-subtitle {
    font-size: 8px;
    line-height: 8px;
    color: var(--color-main-text);
    margin-bottom: 12px;
    white-space: nowrap;
  }

  .drawer__upsell-bottom {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .drawer__upsell-prices {
    display: flex;
    gap: 6px;
    align-items: center;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 600;
    line-height: 10px;
  }
  .drawer__upsell-variantDesr {
    color: #87878D;
    font-size: 8px;
    line-height: 12px;
  }

  .drawer__upsell-button {
    font-size: 14px;
    line-height: 12px;
    color: #fff;
    font-weight: 700;
    background-color: var(--color-main-text);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    width: 80px;
    height: 48px;
    cursor: pointer;
    text-transform: uppercase;
  }

  .price--compare {
    text-decoration: line-through;
    color: #aaa;
  }

  .price--main {
    font-weight: 600;
    color: #000;
  }

  .drawer__upsell .rating-count.caption {
    color: #87878D;
    font-size: 8px;
    line-height: 8px;
  }
</style>
